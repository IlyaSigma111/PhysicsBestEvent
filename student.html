<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üì° FIBER OPTIC ¬∑ —Ç–µ—Å—Ç</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>
    <div id="photons"></div>

    <div class="container">
        <!-- –õ–û–ë–ë–ò -->
        <div id="lobby" class="glass-card">
            <div class="text-center">
                <div style="font-size: 80px; margin-bottom: 20px;">üì°</div>
                <h1 style="color: #4facfe; font-size: 2.5rem; margin-bottom: 10px;">FIBER OPTIC</h1>
                <div style="color: white; margin-bottom: 30px;">7 –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>
                
                <input type="text" id="name" class="input" placeholder="—Ç–≤–æ—ë –∏–º—è" maxlength="15">
                <input type="text" id="code" class="input" placeholder="–∫–æ–¥ —Ç–µ—Å—Ç–∞" maxlength="6">
                
                <button class="btn" onclick="joinGame()">üîÆ –≤–æ–π—Ç–∏</button>
                <div id="error" style="color: #ff6b6b; margin-top: 20px;"></div>
            </div>
        </div>

        <!-- –û–ñ–ò–î–ê–ù–ò–ï -->
        <div id="wait" class="glass-card hidden">
            <div class="text-center">
                <div class="timer" id="waitCode">000000</div>
                <div style="color: white; font-size: 1.2rem;" id="playersCount">0 –∏–≥—Ä–æ–∫–æ–≤</div>
                <div style="color: #4facfe; margin-top: 30px;">‚è≥ –∂–¥—ë–º —Å—Ç–∞—Ä—Ç–∞</div>
            </div>
        </div>

        <!-- –ò–ì–†–ê -->
        <div id="game" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <span style="color: white;" id="playerName"></span>
                <span class="timer" id="timer">15:00</span>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- –°–µ—Ç–∫–∞ –∑–∞–¥–∞–Ω–∏–π -->
            <div class="quest-grid" id="questGrid"></div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
            <div id="taskContainer"></div>

            <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button class="btn secondary" id="prevBtn" onclick="prevTask()">‚Üê –Ω–∞–∑–∞–¥</button>
                <button class="btn" id="nextBtn" onclick="nextTask()">–¥–∞–ª—å—à–µ ‚Üí</button>
            </div>
            
            <button class="btn danger" id="finishBtn" onclick="finishGameEarly()" style="margin-top: 10px;">üì® –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
        </div>

        <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
        <div id="result" class="glass-card hidden">
            <div class="text-center">
                <div style="font-size: 80px; margin-bottom: 20px;">üèÜ</div>
                <div class="timer" id="finalScore">0</div>
                <div style="color: white; margin: 30px 0;" id="finalMessage"></div>
                <button class="btn secondary" onclick="exit()">–≤—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // –°–û–ó–î–ê–Å–ú –§–û–¢–û–ù–´
        // ============================================
        for (let i = 0; i < 30; i++) {
            const photon = document.createElement('div');
            photon.className = 'photon';
            photon.style.left = Math.random() * 100 + '%';
            photon.style.top = Math.random() * 100 + '%';
            photon.style.animationDelay = Math.random() * 10 + 's';
            photon.style.animationDuration = (10 + Math.random() * 20) + 's';
            document.getElementById('photons').appendChild(photon);
        }

        // ============================================
        // 7 –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–• –ó–ê–î–ê–ù–ò–ô
        // ============================================
        const TASKS = [
            // ===== –ó–ê–î–ê–ù–ò–ï 1: –ü–ï–†–ï–í–Å–†–¢–´–®–ò =====
            {
                id: 1,
                type: 'memory',
                title: 'üîÆ –ù–∞–π–¥–∏ –ø–∞—Ä—ã',
                description: '–û—Ç–∫—Ä—ã–≤–∞–π –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –Ω–∞—Ö–æ–¥–∏ —Ç–µ—Ä–º–∏–Ω—ã —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏',
                data: {
                    cards: [
                        { term: '–°–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞', def: '—Ü–µ–Ω—Ç—Ä –≤–æ–ª–æ–∫–Ω–∞, –≥–¥–µ –∏–¥—ë—Ç —Å–≤–µ—Ç' },
                        { term: '–û–±–æ–ª–æ—á–∫–∞', def: '–≤–Ω–µ—à–Ω–∏–π —Å–ª–æ–π —Å –º–µ–Ω—å—à–∏–º n' },
                        { term: '–ö—Ä–∏—Ç. —É–≥–æ–ª', def: '—É–≥–æ–ª, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ü–í–û' },
                        { term: '–ü–í–û', def: '—Å–≤–µ—Ç –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç, n1 > n2' },
                        { term: '–û–¥–Ω–æ–º–æ–¥–æ–≤–æ–µ', def: '—Ç–æ–Ω–∫–∞—è —Å–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞ 8 –º–∫–º' },
                        { term: '–ú–Ω–æ–≥–æ–º–æ–¥–æ–≤–æ–µ', def: '—Ç–æ–ª—Å—Ç–∞—è —Å–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞ 50 –º–∫–º' }
                    ]
                }
            },
            
            // ===== –ó–ê–î–ê–ù–ò–ï 2: –ö–í–ï–°–¢-–õ–ê–ë–ò–†–ò–ù–¢ =====
            {
                id: 2,
                type: 'quest',
                title: 'üó∫Ô∏è –ö–≤–µ—Å—Ç –ª–∞–∑–µ—Ä–∞',
                description: '–ü—Ä–æ–≤–µ–¥–∏ –ª—É—á —á–µ—Ä–µ–∑ –≤—Å–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è. –í—ã–±–∏—Ä–∞–π —É–∑–ª—ã, –≥–¥–µ –±—É–¥–µ—Ç –ü–í–û',
                data: {
                    nodes: [
                        { id: 1, n1: 1.5, n2: 1.4, angle: 60, critical: 69, reflect: false },
                        { id: 2, n1: 1.5, n2: 1.4, angle: 80, critical: 69, reflect: true },
                        { id: 3, n1: 1.4, n2: 1.5, angle: 45, critical: null, reflect: false },
                        { id: 4, n1: 1.5, n2: 1.0, angle: 30, critical: 42, reflect: false },
                        { id: 5, n1: 1.5, n2: 1.0, angle: 50, critical: 42, reflect: true },
                        { id: 6, n1: 1.33, n2: 1.0, angle: 60, critical: 49, reflect: true },
                        { id: 7, n1: 1.5, n2: 1.33, angle: 70, critical: 62, reflect: true },
                        { id: 8, n1: 1.33, n2: 1.5, angle: 40, critical: null, reflect: false }
                    ],
                    correctPath: [1, 2, 5, 7]
                }
            },
            
            // ===== –ó–ê–î–ê–ù–ò–ï 3: –ö–û–ù–°–¢–†–£–ö–¢–û–† =====
            {
                id: 3,
                type: 'constructor',
                title: '‚öôÔ∏è –°–æ–±–µ—Ä–∏ –æ–ø—Ç–æ–≤–æ–ª–æ–∫–Ω–æ',
                description: '–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã',
                data: {
                    categories: [
                        {
                            name: '–°–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞',
                            parts: [
                                { name: '–°—Ç–µ–∫–ª–æ n=1.5', value: 1.5, correct: true },
                                { name: '–ü–ª–∞—Å—Ç–∏–∫ n=1.4', value: 1.4, correct: false },
                                { name: '–í–æ–∑–¥—É—Ö n=1.0', value: 1.0, correct: false }
                            ]
                        },
                        {
                            name: '–û–±–æ–ª–æ—á–∫–∞',
                            parts: [
                                { name: '–°—Ç–µ–∫–ª–æ n=1.4', value: 1.4, correct: true },
                                { name: '–°—Ç–µ–∫–ª–æ n=1.6', value: 1.6, correct: false },
                                { name: '–í–æ–¥–∞ n=1.33', value: 1.33, correct: false }
                            ]
                        },
                        {
                            name: '–õ–∞–∑–µ—Ä',
                            parts: [
                                { name: '850 –Ω–º (–º–Ω–æ–≥–æ–º–æ–¥–æ–≤–æ–µ)', value: 'multi', correct: false },
                                { name: '1550 –Ω–º (–æ–¥–Ω–æ–º–æ–¥–æ–≤–æ–µ)', value: 'single', correct: true }
                            ]
                        }
                    ]
                }
            },
            
            // ===== –ó–ê–î–ê–ù–ò–ï 4: –ù–ê–ô–î–ò –û–®–ò–ë–ö–ò =====
            {
                id: 4,
                type: 'errors',
                title: 'üö® –ù–∞–π–¥–∏ –æ—à–∏–±–∫–∏',
                description: '–í —Å–∏—Å—Ç–µ–º–µ 4 –æ—à–∏–±–∫–∏. –ù–∞–π–¥–∏ –∏—Ö –≤—Å–µ',
                data: {
                    errors: [
                        { text: '–°–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞ n=1.4, –û–±–æ–ª–æ—á–∫–∞ n=1.5', correct: false, hint: 'n –æ–±–æ–ª–æ—á–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ' },
                        { text: '–õ–∞–∑–µ—Ä 1550 –Ω–º –≤ –º–Ω–æ–≥–æ–º–æ–¥–æ–≤–æ–µ –≤–æ–ª–æ–∫–Ω–æ', correct: false, hint: '1550 –Ω–º ‚Üí –æ–¥–Ω–æ–º–æ–¥–æ–≤–æ–µ' },
                        { text: '–£–≥–æ–ª 30¬∞, –∫—Ä–∏—Ç. —É–≥–æ–ª 42¬∞ ‚Äî –ü–í–û –µ—Å—Ç—å', correct: false, hint: '–ü–í–û —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–≥–æ–ª > –∫—Ä–∏—Ç.' },
                        { text: '–î–ª–∏–Ω–∞ 5000 –∫–º –±–µ–∑ —É—Å–∏–ª–∏—Ç–µ–ª–µ–π', correct: false, hint: '–ù—É–∂–Ω—ã —É—Å–∏–ª–∏—Ç–µ–ª–∏ –∫–∞–∂–¥—ã–µ 100 –∫–º' },
                        { text: '–°–∫–æ—Ä–æ—Å—Ç—å —Å–≤–µ—Ç–∞ –≤ —Å—Ç–µ–∫–ª–µ 200 000 –∫–º/—Å', correct: true }
                    ]
                }
            },
            
            // ===== –ó–ê–î–ê–ù–ò–ï 5: –ë–ò–¢–í–ê –õ–£–ß–ï–ô =====
            {
                id: 5,
                type: 'battle',
                title: '‚öîÔ∏è –ë–∏—Ç–≤–∞ –ª—É—á–µ–π',
                description: '–ö—Ç–æ –æ—Ç—Ä–∞–∑–∏—Ç—Å—è, –∞ –∫—Ç–æ –≤—ã–π–¥–µ—Ç?',
                data: {
                    beams: [
                        { 
                            name: '–õ—É—á A',
                            desc: '–°—Ç–µ–∫–ª–æ (1.5) ‚Üí –í–æ–¥–∞ (1.33), —É–≥–æ–ª 50¬∞',
                            critical: 62,
                            willReflect: false
                        },
                        { 
                            name: '–õ—É—á B',
                            desc: '–°—Ç–µ–∫–ª–æ (1.5) ‚Üí –í–æ–∑–¥—É—Ö (1.0), —É–≥–æ–ª 50¬∞',
                            critical: 42,
                            willReflect: true
                        }
                    ]
                }
            },
            
            // ===== –ó–ê–î–ê–ù–ò–ï 6: –ì–û–ù–ö–ê –°–í–ï–¢–ê =====
            {
                id: 6,
                type: 'race',
                title: '‚è±Ô∏è –ì–æ–Ω–∫–∞ —Å–≤–µ—Ç–∞',
                description: '–ü–æ—Å—á–∏—Ç–∞–π –≤—Ä–µ–º—è (—Å–∫–æ—Ä–æ—Å—Ç—å —Å–≤–µ—Ç–∞ –≤ –≤–æ–ª–æ–∫–Ω–µ ‚âà 200 000 –∫–º/—Å)',
                data: {
                    questions: [
                        { text: '–ú–æ—Å–∫–≤–∞ ‚Üí –ü–∏—Ç–µ—Ä (700 –∫–º)', answer: 3.5, unit: '–º—Å' },
                        { text: '–ó–µ–º–ª—è ‚Üí –õ—É–Ω–∞ (384 000 –∫–º)', answer: 1.28, unit: '—Å' },
                        { text: '–í–æ–∫—Ä—É–≥ —ç–∫–≤–∞—Ç–æ—Ä–∞ (40 000 –∫–º)', answer: 0.133, unit: '—Å' }
                    ]
                }
            },
            
            // ===== –ó–ê–î–ê–ù–ò–ï 7: –°–û–ë–ï–†–ò –§–û–†–ú–£–õ–£ =====
            {
                id: 7,
                type: 'formula',
                title: 'üß© –°–æ–±–µ—Ä–∏ —Ñ–æ—Ä–º—É–ª—É',
                description: '–ü–æ—Å—Ç–∞–≤—å —á–∞—Å—Ç–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (—Ñ–æ—Ä–º—É–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–≥–ª–∞)',
                data: {
                    pieces: ['sin', 'Œ±', '=', 'n‚ÇÇ', '/', 'n‚ÇÅ', 'arcsin', '(', ')'],
                    correct: ['arcsin', '(', 'n‚ÇÇ', '/', 'n‚ÇÅ', ')']
                }
            }
        ];

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameId = null;
        let playerName = '';
        let currentTask = 0;
        let answers = {};
        let timerInterval = null;

        // ===== –í–•–û–î –í –ò–ì–†–£ =====
        window.joinGame = function() {
            const name = document.getElementById('name').value.trim();
            const code = document.getElementById('code').value.trim();

            if (!name) return showError('‚ùå –≤–≤–µ–¥–∏ –∏–º—è');
            if (!code || code.length !== 6) return showError('‚ùå –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6 —Ü–∏—Ñ—Ä');

            playerName = name;
            gameId = `game_${code}`;

            document.getElementById('playerName').innerText = name;
            document.getElementById('waitCode').innerText = code;

            db.ref(`games/${gameId}`).once('value', (snap) => {
                const data = snap.val();
                if (!data) {
                    showError('‚ùå –∏–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }

                db.ref(`games/${gameId}/players/${name}`).set({
                    name: name,
                    joinedAt: Date.now(),
                    answers: {},
                    progress: 0
                });

                document.getElementById('lobby').classList.add('hidden');
                document.getElementById('wait').classList.remove('hidden');
                listenToGame();
            });
        };

        // ===== –°–õ–£–®–ê–ï–ú –ò–ì–†–£ =====
        function listenToGame() {
            db.ref(`games/${gameId}`).on('value', (snap) => {
                const data = snap.val();
                if (!data) return;

                if (data.players) {
                    const count = Object.keys(data.players).length;
                    document.getElementById('playersCount').innerText = count + ' –∏–≥—Ä–æ–∫–æ–≤';
                }

                if (data.status === 'active') {
                    document.getElementById('wait').classList.add('hidden');
                    document.getElementById('game').classList.remove('hidden');
                    
                    if (data.players && data.players[playerName]) {
                        answers = data.players[playerName].answers || {};
                    }
                    
                    renderQuestGrid();
                    showTask(currentTask);
                    
                    if (data.startTime) {
                        startTimer(data.startTime, data.timeLimit || 900);
                    }
                }

                if (data.status === 'finished') {
                    finishGame();
                }
            });
        }

        // ===== –¢–ê–ô–ú–ï–† =====
        function startTimer(startTime, limit) {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = Math.max(0, limit - elapsed);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                
                document.getElementById('timer').innerText = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    finishGame();
                }
            }, 1000);
        }

        // ===== –°–ï–¢–ö–ê –ó–ê–î–ê–ù–ò–ô =====
        function renderQuestGrid() {
            let html = '';
            for (let i = 1; i <= 7; i++) {
                const answered = answers[i] !== undefined ? 'completed' : '';
                const current = i === currentTask + 1 ? 'current' : '';
                html += `<div class="quest-btn ${answered} ${current}" onclick="jumpToTask(${i-1})">${i}</div>`;
            }
            document.getElementById('questGrid').innerHTML = html;
            
            const progress = (Object.keys(answers).length / 7) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // ===== –ü–ï–†–ï–ô–¢–ò –ö –ó–ê–î–ê–ù–ò–Æ =====
        window.jumpToTask = function(index) {
            currentTask = index;
            renderQuestGrid();
            showTask(index);
        };

        // ===== –ü–û–ö–ê–ó–ê–¢–¨ –ó–ê–î–ê–ù–ò–ï =====
        function showTask(index) {
            const task = TASKS[index];
            const container = document.getElementById('taskContainer');
            
            switch(task.type) {
                case 'memory':
                    showMemoryTask(task, container);
                    break;
                case 'quest':
                    showQuestTask(task, container);
                    break;
                case 'constructor':
                    showConstructorTask(task, container);
                    break;
                case 'errors':
                    showErrorsTask(task, container);
                    break;
                case 'battle':
                    showBattleTask(task, container);
                    break;
                case 'race':
                    showRaceTask(task, container);
                    break;
                case 'formula':
                    showFormulaTask(task, container);
                    break;
            }
        }

        // ===== –¢–ò–ü 1: MEMORY =====
        function showMemoryTask(task, container) {
            let html = `
                <div class="glass-card" style="margin: 20px 0;">
                    <h2 style="color: #4facfe;">${task.title}</h2>
                    <p style="color: white; margin-bottom: 20px;">${task.description}</p>
                    <div class="memory-grid" id="memoryGrid"></div>
                </div>
            `;
            container.innerHTML = html;

            const cards = [];
            task.data.cards.forEach((c, i) => {
                cards.push({ id: `term_${i}`, text: c.term, pair: i, type: 'term' });
                cards.push({ id: `def_${i}`, text: c.def, pair: i, type: 'def' });
            });
            
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }

            let gridHtml = '';
            cards.forEach((card, i) => {
                gridHtml += `
                    <div class="memory-card" id="card_${i}" data-pair="${card.pair}" onclick="flipCard(this, ${i})">
                        ‚ùì
                    </div>
                `;
            });
            document.getElementById('memoryGrid').innerHTML = gridHtml;

            window.memoryCards = cards;
            window.flippedCards = [];
            window.matchedPairs = [];
        }

        window.flipCard = function(element, index) {
            if (element.classList.contains('matched')) return;
            if (window.flippedCards.length >= 2) return;
            if (element.classList.contains('flipped')) return;

            const card = window.memoryCards[index];
            element.classList.add('flipped');
            element.innerText = card.text;
            
            window.flippedCards.push({ element, index, pair: card.pair, type: card.type });

            if (window.flippedCards.length === 2) {
                checkMatch();
            }
        };

        function checkMatch() {
            const [card1, card2] = window.flippedCards;
            
            if (card1.pair === card2.pair && card1.type !== card2.type) {
                card1.element.classList.add('matched');
                card2.element.classList.add('matched');
                window.matchedPairs.push(card1.pair);
                
                if (window.matchedPairs.length === 6) {
                    setTimeout(() => {
                        saveAnswer(1, true);
                    }, 500);
                }
            } else {
                setTimeout(() => {
                    card1.element.classList.remove('flipped');
                    card2.element.classList.remove('flipped');
                    card1.element.innerText = '‚ùì';
                    card2.element.innerText = '‚ùì';
                }, 1000);
            }
            
            window.flippedCards = [];
        }

        // ===== –¢–ò–ü 2: –ö–í–ï–°–¢ =====
        function showQuestTask(task, container) {
            let html = `
                <div class="glass-card" style="margin: 20px 0;">
                    <h2 style="color: #4facfe;">${task.title}</h2>
                    <p style="color: white; margin-bottom: 20px;">${task.description}</p>
                    <div class="quest-map" id="questMap"></div>
                    <div style="color: #4facfe; text-align: center; margin: 20px;" id="questMessage"></div>
                </div>
            `;
            container.innerHTML = html;

            let mapHtml = '';
            task.data.nodes.forEach(node => {
                mapHtml += `
                    <div class="node" id="node_${node.id}" onclick="selectNode(${node.id})">
                        <div>${node.id}</div>
                        <small>${node.n1}‚Üí${node.n2}</small>
                    </div>
                `;
            });
            document.getElementById('questMap').innerHTML = mapHtml;

            window.questData = task.data;
            window.currentPath = [];
            window.questTaskId = task.id;
        }

        window.selectNode = function(nodeId) {
            const node = window.questData.nodes.find(n => n.id === nodeId);
            const element = document.getElementById(`node_${nodeId}`);
            
            if (node.reflect) {
                element.classList.add('correct');
                window.currentPath.push(nodeId);
                
                if (window.currentPath.length === window.questData.correctPath.length) {
                    const isCorrect = window.currentPath.every((id, i) => id === window.questData.correctPath[i]);
                    document.getElementById('questMessage').innerText = isCorrect ? '‚úÖ –õ—É—á –ø—Ä–æ—à—ë–ª!' : '‚ùå –ù–µ —Ç–æ—Ç –ø—É—Ç—å';
                    if (isCorrect) saveAnswer(2, true);
                }
            } else {
                element.classList.add('wrong');
                document.getElementById('questMessage').innerText = '‚ùå –õ—É—á –ø–æ—Ç–µ—Ä—è–Ω';
                setTimeout(() => element.classList.remove('wrong'), 1000);
            }
        };

        // ===== –¢–ò–ü 3: –ö–û–ù–°–¢–†–£–ö–¢–û–† =====
        function showConstructorTask(task, container) {
            let html = `
                <div class="glass-card" style="margin: 20px 0;">
                    <h2 style="color: #4facfe;">${task.title}</h2>
                    <p style="color: white; margin-bottom: 20px;">${task.description}</p>
                    <div class="constructor-parts" id="constructorParts"></div>
                    <button class="btn small" onclick="checkConstructor()" style="margin-top: 20px;">‚úÖ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            `;
            container.innerHTML = html;

            let partsHtml = '';
            task.data.categories.forEach((cat, catIndex) => {
                partsHtml += `
                    <div class="part-category">
                        <div class="category-title">${cat.name}</div>
                        <div class="part-options" data-category="${catIndex}">
                `;
                
                cat.parts.forEach((part, partIndex) => {
                    partsHtml += `
                        <div class="part" onclick="selectPart(${catIndex}, ${partIndex})" 
                             data-cat="${catIndex}" data-part="${partIndex}">
                            ${part.name}
                        </div>
                    `;
                });
                
                partsHtml += `</div></div>`;
            });
            
            document.getElementById('constructorParts').innerHTML = partsHtml;
            window.constructorData = task.data;
            window.selectedParts = {};
        }

        window.selectPart = function(catIndex, partIndex) {
            document.querySelectorAll(`[data-category="${catIndex}"] .part`).forEach(el => {
                el.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            window.selectedParts[catIndex] = partIndex;
        };

        window.checkConstructor = function() {
            const data = window.constructorData;
            let correct = true;
            
            for (let catIndex in window.selectedParts) {
                const partIndex = window.selectedParts[catIndex];
                if (!data.categories[catIndex].parts[partIndex].correct) {
                    correct = false;
                }
            }
            
            if (correct && Object.keys(window.selectedParts).length === 3) {
                saveAnswer(3, true);
                alert('‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!');
            } else {
                alert('‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏');
            }
        };

        // ===== –¢–ò–ü 4: –ù–ê–ô–î–ò –û–®–ò–ë–ö–ò =====
        function showErrorsTask(task, container) {
            let html = `
                <div class="glass-card" style="margin: 20px 0;">
                    <h2 style="color: #4facfe;">${task.title}</h2>
                    <p style="color: white; margin-bottom: 20px;">${task.description}</p>
                    <div class="error-list" id="errorList"></div>
                    <div style="color: #4facfe; margin-top: 20px;" id="errorsCount">–ù–∞–π–¥–µ–Ω–æ: 0/4</div>
                </div>
            `;
            container.innerHTML = html;

            let listHtml = '';
            task.data.errors.forEach((error, index) => {
                listHtml += `
                    <div class="error-item" onclick="toggleError(${index})" id="error_${index}">
                        <div class="error-icon">!</div>
                        <div>${error.text}</div>
                    </div>
                `;
            });
            
            document.getElementById('errorList').innerHTML = listHtml;
            window.errorsData = task.data;
            window.foundErrors = [];
        }

        window.toggleError = function(index) {
            const element = document.getElementById(`error_${index}`);
            const error = window.errorsData.errors[index];
            
            if (!error.correct) {
                if (window.foundErrors.includes(index)) {
                    element.classList.remove('fixed');
                    window.foundErrors = window.foundErrors.filter(i => i !== index);
                } else {
                    element.classList.add('fixed');
                    window.foundErrors.push(index);
                }
                
                document.getElementById('errorsCount').innerText = `–ù–∞–π–¥–µ–Ω–æ: ${window.foundErrors.length}/4`;
                
                if (window.foundErrors.length === 4) {
                    saveAnswer(4, true);
                }
            }
        };

        // ===== –¢–ò–ü 5: –ë–ò–¢–í–ê =====
        function showBattleTask(task, container) {
            let html = `
                <div class="glass-card" style="margin: 20px 0;">
                    <h2 style="color: #4facfe;">${task.title}</h2>
                    <p style="color: white; margin-bottom: 20px;">${task.description}</p>
                    <div class="battle-arena" id="battleArena"></div>
                </div>
            `;
            container.innerHTML = html;

            let arenaHtml = '';
            task.data.beams.forEach((beam, index) => {
                arenaHtml += `
                    <div class="beam" onclick="selectBeam(${index})" id="beam_${index}">
                        <h3 style="margin-bottom: 10px;">${beam.name}</h3>
                        <p>${beam.desc}</p>
                    </div>
                `;
            });
            
            document.getElementById('battleArena').innerHTML = arenaHtml;
            window.battleData = task.data;
        }

        window.selectBeam = function(index) {
            const beam = window.battleData.beams[index];
            const element = document.getElementById(`beam_${index}`);
            
            if (beam.willReflect) {
                element.classList.add('correct');
                saveAnswer(5, true);
            } else {
                element.classList.add('wrong');
                setTimeout(() => element.classList.remove('wrong'), 1000);
            }
        };

        // ===== –¢–ò–ü 6: –ì–û–ù–ö–ê =====
        function showRaceTask(task, container) {
            let html = `
                <div class="glass-card" style="margin: 20px 0;">
                    <h2 style="color: #4facfe;">${task.title}</h2>
                    <p style="color: white; margin-bottom: 20px;">${task.description}</p>
                    <div class="race-questions" id="raceQuestions"></div>
                    <button class="btn small" onclick="checkRace()">‚úÖ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            `;
            container.innerHTML = html;

            let questionsHtml = '';
            task.data.questions.forEach((q, index) => {
                questionsHtml += `
                    <div class="race-item">
                        <div class="race-question">${q.text}</div>
                        <input type="number" class="race-input" id="race_${index}" step="0.001" placeholder="–æ—Ç–≤–µ—Ç –≤ ${q.unit}">
                    </div>
                `;
            });
            
            document.getElementById('raceQuestions').innerHTML = questionsHtml;
            window.raceData = task.data;
        }

        window.checkRace = function() {
            let correct = true;
            
            window.raceData.questions.forEach((q, index) => {
                const input = document.getElementById(`race_${index}`);
                const value = parseFloat(input.value);
                
                if (Math.abs(value - q.answer) < 0.01) {
                    input.classList.add('correct');
                } else {
                    input.classList.remove('correct');
                    correct = false;
                }
            });
            
            if (correct) {
                saveAnswer(6, true);
                alert('‚úÖ –í—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!');
            } else {
                alert('‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏');
            }
        };

        // ===== –¢–ò–ü 7: –§–û–†–ú–£–õ–ê =====
        function showFormulaTask(task, container) {
            let html = `
                <div class="glass-card" style="margin: 20px 0;">
                    <h2 style="color: #4facfe;">${task.title}</h2>
                    <p style="color: white; margin-bottom: 20px;">${task.description}</p>
                    <div class="formula-builder">
                        <div class="formula-pieces" id="formulaPieces"></div>
                        <div class="formula-slot" id="formulaSlot"></div>
                        <button class="btn small" onclick="checkFormula()">‚úÖ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                    </div>
                </div>
            `;
            container.innerHTML = html;

            let piecesHtml = '';
            task.data.pieces.forEach((piece, index) => {
                piecesHtml += `
                    <div class="piece" onclick="addToFormula('${piece}', ${index})">
                        ${piece}
                    </div>
                `;
            });
            
            document.getElementById('formulaPieces').innerHTML = piecesHtml;
            window.formulaData = task.data;
            window.currentFormula = [];
        }

        window.addToFormula = function(piece, index) {
            window.currentFormula.push(piece);
            renderFormulaSlot();
        };

        function renderFormulaSlot() {
            let html = '';
            window.currentFormula.forEach((piece, i) => {
                html += `
                    <div class="slot-piece" onclick="removeFromFormula(${i})">
                        ${piece}
                    </div>
                `;
            });
            document.getElementById('formulaSlot').innerHTML = html;
        }

        window.removeFromFormula = function(index) {
            window.currentFormula.splice(index, 1);
            renderFormulaSlot();
        };

        window.checkFormula = function() {
            const correct = window.formulaData.correct;
            const isCorrect = window.currentFormula.length === correct.length &&
                window.currentFormula.every((val, i) => val === correct[i]);
            
            if (isCorrect) {
                saveAnswer(7, true);
                alert('‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!');
            } else {
                alert('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ');
            }
        };

        // ===== –°–û–•–†–ê–ù–ò–¢–¨ –û–¢–í–ï–¢ =====
        function saveAnswer(taskId, correct) {
            answers[taskId] = correct;
            
            db.ref(`games/${gameId}/players/${playerName}/answers/${taskId}`).set(correct);
            db.ref(`games/${gameId}/players/${playerName}/progress`).set(Object.keys(answers).length);
            
            renderQuestGrid();
            
            if (taskId === currentTask + 1) {
                document.getElementById('nextBtn').style.opacity = '1';
            }
        }

        // ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø =====
        window.prevTask = function() {
            if (currentTask > 0) {
                currentTask--;
                renderQuestGrid();
                showTask(currentTask);
            }
        };

        window.nextTask = function() {
            if (answers[currentTask + 1] === undefined) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ!');
                return;
            }
            
            if (currentTask < 6) {
                currentTask++;
                renderQuestGrid();
                showTask(currentTask);
            } else {
                finishGameEarly();
            }
        };

        window.finishGameEarly = function() {
            if (Object.keys(answers).length < 7) {
                if (!confirm('–¢—ã –≤—ã–ø–æ–ª–Ω–∏–ª –Ω–µ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è. –ó–∞–≤–µ—Ä—à–∏—Ç—å?')) return;
            }
            finishGame();
        };

        // ===== –ó–ê–í–ï–†–®–ò–¢–¨ –ò–ì–†–£ =====
        function finishGame() {
            let score = 0;
            for (let i = 1; i <= 7; i++) {
                if (answers[i]) score += 10;
            }
            
            db.ref(`games/${gameId}/players/${playerName}/score`).set(score);
            
            document.getElementById('game').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('finalScore').innerText = score + ' ‚ú®';
            
            if (score === 70) document.getElementById('finalMessage').innerText = 'üåü –ò–¥–µ–∞–ª—å–Ω–æ! –¢—ã –º–∞—Å—Ç–µ—Ä —Å–≤–µ—Ç–∞!';
            else if (score >= 50) document.getElementById('finalMessage').innerText = 'üí´ –•–æ—Ä–æ—à–æ! –¢—ã –ø–æ–Ω—è–ª —Ñ–∏–∑–∏–∫—É';
            else document.getElementById('finalMessage').innerText = 'üîÆ –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑';
            
            if (timerInterval) clearInterval(timerInterval);
        }

        // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï =====
        function showError(msg) {
            document.getElementById('error').innerText = msg;
        }

        window.exit = function() {
            location.href = 'index.html';
        };

        document.getElementById('code')?.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').substring(0, 6);
        });
    </script>
</body>
</html>
