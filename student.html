<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIBER OPTIC ¬∑ —Ç–µ—Å—Ç</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* APPLE –°–¢–ò–õ–ò –î–õ–Ø –£–ß–ï–ù–ò–ö–ê */
        body {
            background: #f5f5f7;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .student-container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 32px;
            padding: 32px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
            border: 1px solid #f0f0f3;
        }
        
        /* –®–ê–ü–ö–ê */
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .student-name {
            background: #f5f5f7;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 500;
            color: #1d1d1f;
            font-size: 1rem;
        }
        
        .student-timer {
            font-family: 'SF Mono', monospace;
            font-size: 2rem;
            font-weight: 500;
            color: #1d1d1f;
            background: #f5f5f7;
            padding: 8px 20px;
            border-radius: 30px;
        }
        
        /* –ü–†–û–ì–†–ï–°–° */
        .progress-section {
            margin-bottom: 24px;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #6e6e73;
            font-size: 0.9rem;
        }
        
        /* –ö–ê–†–¢–û–ß–ö–ê –í–û–ü–†–û–°–ê */
        .question-card {
            background: #f5f5f7;
            border-radius: 28px;
            padding: 32px;
            margin: 24px 0;
        }
        
        .question-text {
            font-size: 1.3rem;
            line-height: 1.5;
            color: #1d1d1f;
            font-weight: 500;
            margin-bottom: 24px;
        }
        
        /* –í–ê–†–ò–ê–ù–¢–´ */
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option {
            background: white;
            border: 1px solid #e9e9ed;
            border-radius: 16px;
            padding: 16px 20px;
            font-size: 1rem;
            color: #1d1d1f;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .option:hover {
            border-color: #0071e3;
        }
        
        .option.selected {
            background: #0071e3;
            border-color: #0071e3;
            color: white;
        }
        
        /* –†–ê–°–ß–Å–¢–ù–´–ô –ë–õ–û–ö */
        .calc-block {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #e9e9ed;
        }
        
        .calc-label {
            color: #6e6e73;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .formula {
            font-family: 'SF Mono', monospace;
            font-size: 1.2rem;
            background: #f5f5f7;
            padding: 12px;
            border-radius: 12px;
        }
        
        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø - –¢–û–õ–¨–ö–û –°–¢–†–ï–õ–ö–ò */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }
        
        .nav-left {
            display: flex;
            gap: 8px;
        }
        
        .nav-arrow {
            width: 48px;
            height: 48px;
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #1d1d1f;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-arrow:hover {
            border-color: #0071e3;
            color: #0071e3;
        }
        
        .nav-submit {
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 40px;
            padding: 12px 28px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-submit:hover {
            background: #0077ed;
        }
        
        /* –≠–ö–†–ê–ù–´ */
        .screen {
            display: flex;
            flex-direction: column;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* –ö–û–î –û–ñ–ò–î–ê–ù–ò–Ø */
        .code-display {
            font-family: 'SF Mono', monospace;
            font-size: 4rem;
            text-align: center;
            padding: 30px;
            background: #f5f5f7;
            border-radius: 40px;
            margin: 30px 0;
            letter-spacing: 10px;
            color: #1d1d1f;
        }
        
        /* –†–ï–ó–£–õ–¨–¢–ê–¢ */
        .score {
            font-size: 5rem;
            font-weight: 700;
            text-align: center;
            margin: 30px 0;
            color: #1d1d1f;
        }
        
        .final-message {
            font-size: 1.2rem;
            color: #6e6e73;
            text-align: center;
            margin: 20px 0;
        }
        
        /* –ü–û–õ–Ø –í–í–û–î–ê */
        .apple-input {
            background: #f5f5f7;
            border: 1px solid #e9e9ed;
            border-radius: 16px;
            padding: 16px 20px;
            font-size: 1rem;
            width: 100%;
            margin: 8px 0;
        }
        
        .apple-input:focus {
            outline: none;
            border-color: #0071e3;
        }
        
        .apple-button {
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 16px;
            font-size: 1rem;
            font-weight: 500;
            width: 100%;
            margin: 8px 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="student-container">
        <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
        <div id="screenLobby" class="screen">
            <h1>FIBER OPTIC</h1>
            <div class="subtitle">30 –∑–∞–¥–∞–Ω–∏–π ¬∑ –ø–æ–ª–Ω–æ–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ</div>
            
            <input type="text" id="playerName" class="apple-input" placeholder="–¢–≤–æ—ë –∏–º—è" maxlength="15">
            <input type="text" id="gameCode" class="apple-input" placeholder="–ö–æ–¥ —Ç–µ—Å—Ç–∞" maxlength="6">
            
            <button class="apple-button" onclick="joinGame()">–í–æ–π—Ç–∏</button>
            <div id="errorMsg" style="color: #ff3b30; margin-top: 16px; text-align: center;"></div>
        </div>

        <!-- –≠–ö–†–ê–ù –û–ñ–ò–î–ê–ù–ò–Ø -->
        <div id="screenWait" class="screen hidden">
            <h1>–û–∂–∏–¥–∞–Ω–∏–µ</h1>
            <div class="code-display" id="displayCode">000000</div>
            <div class="text-center" id="playersCount" style="font-size: 1.2rem;">0 –∏–≥—Ä–æ–∫–æ–≤</div>
        </div>

        <!-- –≠–ö–†–ê–ù –¢–ï–°–¢–ê -->
        <div id="screenGame" class="screen hidden">
            <!-- –®–ê–ü–ö–ê -->
            <div class="student-header">
                <span class="student-name" id="displayName"></span>
                <span class="student-timer" id="displayTimer">15:00</span>
            </div>

            <!-- –ü–†–û–ì–†–ï–°–° -->
            <div class="progress-section">
                <div class="progress-stats">
                    <span id="answeredCount">0/30</span>
                    <span>üßÆ —Ä–∞—Å—á—ë—Ç–Ω—ã–µ</span>
                </div>
                <div class="apple-progress">
                    <div class="apple-progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- –í–û–ü–†–û–° -->
            <div class="question-card">
                <div class="question-text" id="questionText"></div>
                
                <div id="calcBlock" class="calc-block hidden">
                    <div class="calc-label">—Ä–∞—Å—á—ë—Ç –≤ —Ç–µ—Ç—Ä–∞–¥–∏</div>
                    <div class="formula" id="formulaDisplay"></div>
                </div>
                
                <div class="options" id="optionsContainer"></div>
            </div>

            <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø (–¢–û–õ–¨–ö–û –°–¢–†–ï–õ–ö–ò) -->
            <div class="navigation">
                <div class="nav-left">
                    <div class="nav-arrow" onclick="prevQuestion()" id="prevBtn">‚Üê</div>
                    <div class="nav-arrow" onclick="nextQuestion()" id="nextBtn">‚Üí</div>
                </div>
                <button class="nav-submit" onclick="submitTest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù –†–ï–ó–£–õ–¨–¢–ê–¢–ê -->
        <div id="screenResult" class="screen hidden">
            <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç</h1>
            <div class="score" id="finalScore">0</div>
            <div class="final-message" id="finalMessage"></div>
            <button class="apple-button" onclick="exit()" style="margin-top: 40px;">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <script>
        // ===== FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyC_86gSXMHhRXk3q63usfJK3fQrFhQU7Ig",
            authDomain: "physicsproject-b5660.firebaseapp.com",
            databaseURL: "https://physicsproject-b5660-default-rtdb.firebaseio.com",
            projectId: "physicsproject-b5660",
            storageBucket: "physicsproject-b5660.firebasestorage.app",
            messagingSenderId: "244631414073",
            appId: "1:244631414073:web:69b4bdc74e233051f474e8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ===== 30 –í–û–ü–†–û–°–û–í =====
        const QUESTIONS = [
            // ... (—Ç–µ –∂–µ 30 –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ –∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)
            // –Ø —Å–æ–∫—Ä–∞—Ç–∏–ª –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏, –Ω–æ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤—Å–µ 30 –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
        ];

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let gameId = null;
        let playerName = '';
        let currentQuestion = 0;
        let answers = {};
        let timerInterval = null;

        // ===== –í–•–û–î =====
        window.joinGame = function() {
            const name = document.getElementById('playerName').value.trim();
            const code = document.getElementById('gameCode').value.trim();

            if (!name) return showError('–í–≤–µ–¥–∏ –∏–º—è');
            if (!code || code.length !== 6) return showError('–ö–æ–¥: 6 —Ü–∏—Ñ—Ä');

            playerName = name;
            gameId = `game_${code}`;

            document.getElementById('displayName').innerText = name;
            document.getElementById('displayCode').innerText = code;

            db.ref(`games/${gameId}`).once('value', (snap) => {
                if (!snap.val()) return showError('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');

                db.ref(`games/${gameId}/players/${name}`).set({
                    name: name,
                    joinedAt: Date.now(),
                    answers: {}
                });

                switchScreen('lobby', 'wait');
                listenToGame();
            });
        };

        function listenToGame() {
            db.ref(`games/${gameId}`).on('value', (snap) => {
                const data = snap.val();
                if (!data) return;

                if (data.players) {
                    document.getElementById('playersCount').innerText = 
                        Object.keys(data.players).length + ' –∏–≥—Ä–æ–∫–æ–≤';
                }

                if (data.status === 'active') {
                    switchScreen('wait', 'game');
                    
                    if (data.players?.[playerName]?.answers) {
                        answers = data.players[playerName].answers;
                    }
                    
                    showQuestion(currentQuestion);
                    updateProgress();
                    
                    if (data.startTime) {
                        startTimer(data.startTime, data.timeLimit || 900);
                    }
                }

                if (data.status === 'finished') {
                    finishGame();
                }
            });
        }

        function switchScreen(from, to) {
            document.getElementById(`screen${from[0].toUpperCase() + from.slice(1)}`).classList.add('hidden');
            document.getElementById(`screen${to[0].toUpperCase() + to.slice(1)}`).classList.remove('hidden');
        }

        function startTimer(startTime, limit) {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const remaining = Math.max(0, limit - Math.floor((Date.now() - startTime) / 1000));
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                document.getElementById('displayTimer').innerText = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (remaining <= 0) submitTest();
            }, 1000);
        }

        function updateProgress() {
            const answered = Object.keys(answers).length;
            document.getElementById('answeredCount').innerText = `${answered}/30`;
            document.getElementById('progressFill').style.width = (answered / 30 * 100) + '%';
        }

        function showQuestion(index) {
            const q = QUESTIONS[index];
            document.getElementById('questionText').innerText = q.text;
            
            if (q.isCalc) {
                document.getElementById('calcBlock').classList.remove('hidden');
                document.getElementById('formulaDisplay').innerText = q.formula;
            } else {
                document.getElementById('calcBlock').classList.add('hidden');
            }
            
            let optionsHtml = '';
            q.options.forEach((opt, i) => {
                const selected = answers[q.id] === i ? 'selected' : '';
                optionsHtml += `<div class="option ${selected}" onclick="selectAnswer(${q.id}, ${i})">${opt}</div>`;
            });
            document.getElementById('optionsContainer').innerHTML = optionsHtml;
        }

        window.selectAnswer = (qid, opt) => {
            answers[qid] = opt;
            db.ref(`games/${gameId}/players/${playerName}/answers/${qid}`).set(opt);
            updateProgress();
            
            // –õ–æ–≥ –¥–ª—è —É—á–∏—Ç–µ–ª—è
            db.ref(`games/${gameId}/logs`).push().set({
                name: playerName,
                action: `–æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–æ–ø—Ä–æ—Å ${qid}`,
                timestamp: Date.now()
            });
            
            document.querySelectorAll('.option').forEach((el, i) => {
                if (i === opt) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        };

        window.prevQuestion = () => {
            if (currentQuestion > 0) {
                currentQuestion--;
                showQuestion(currentQuestion);
            }
        };

        window.nextQuestion = () => {
            if (currentQuestion < 29) {
                currentQuestion++;
                showQuestion(currentQuestion);
            }
        };

        window.submitTest = function() {
            if (Object.keys(answers).length < 30 && !confirm('–ù–µ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è. –û—Ç–ø—Ä–∞–≤–∏—Ç—å?')) return;
            
            let correct = 0;
            for (let i = 1; i <= 30; i++) {
                if (answers[i] === QUESTIONS[i-1].correct) correct++;
            }
            const score = Math.round(correct * 3.33);
            
            db.ref(`games/${gameId}/players/${playerName}`).update({
                answers: answers,
                score: score,
                correct: correct,
                submittedAt: Date.now()
            }).then(() => {
                finishGame();
            });
        };

        function finishGame() {
            if (timerInterval) clearInterval(timerInterval);
            db.ref(`games/${gameId}/players/${playerName}`).once('value', (snap) => {
                const player = snap.val();
                switchScreen('game', 'result');
                document.getElementById('finalScore').innerText = (player.score || 0) + ' ‚ú®';
                const correct = player.correct || 0;
                let msg = `–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correct}/30`;
                if (correct >= 27) msg += ' ¬∑ –ò–¥–µ–∞–ª—å–Ω–æ!';
                else if (correct >= 24) msg += ' ¬∑ –û—Ç–ª–∏—á–Ω–æ!';
                else if (correct >= 18) msg += ' ¬∑ –•–æ—Ä–æ—à–æ';
                else msg += ' ¬∑ –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë';
                document.getElementById('finalMessage').innerText = msg;
            });
        }

        function showError(msg) {
            document.getElementById('errorMsg').innerText = msg;
        }

        window.exit = () => location.reload();

        document.getElementById('gameCode')?.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').substring(0, 6);
        });
    </script>
</body>
</html>
